@using Basyc.MessageBus.Manager.Application.ResultDiagnostics
@using Basyc.MessageBus.Manager.Application
@using Basyc.MessageBus.Manager.Presentation.BlazorLibrary.Components
@using Basyc.MessageBus.Manager.Presentation.BlazorLibrary.Components.DurationMap
@using Basyc.MessageBus.Manager.Presentation.BlazorLibrary.Components.DurationMap.Horizontal
@using Basyc.MessageBus.Manager.Presentation.BlazorLibrary.Components.LogWindow
@using Basyc.MessageBus.Manager.Presentation.BlazorLibrary.Shared.Helpers

<resultHistoryItemExpandedView>
    <basicSection>
        <basicTable>
            <MudGrid Spacing="0">
                <MudItem lg="6">
                    <MudStack Spacing="2">
                        <formLabel>
                            StartTime
                        </formLabel>
                        <formLabel>
                            State
                        </formLabel>
                        <formLabel>
                            Duration
                        </formLabel>
                        <formLabel>
                            TraceId
                        </formLabel>
                    </MudStack>
                </MudItem>
                <MudItem lg="6">
                    <MudStack Spacing="2">
                        <formValue>
                            @if (RequestResult.DurationMap != null)
                            {
                                @TimeConverter.TimeToText(RequestResult.DurationMap.StartTime)
                            }
                        </formValue>
                        <formValue>
                            @RequestResult.State.ToString()
                        </formValue>
                        <formValue>
                            <LatencyView RequestResult="RequestResult" />
                        </formValue>
                        <formValue>
                            @RequestResult.TraceId
                        </formValue>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </basicTable>

        <dataSubSection>
            <requestBox>
                <textValue>
                    @ResponseResultConverter.CreateInputOverview(RequestResult.Request.Parameters)
                </textValue>
            </requestBox>
            <arrow>
                <MudIcon Icon="@Icons.Material.Rounded.Forward" />
            </arrow>

            <responseBox>
                @if (RequestResult.State == RequestResultState.Started)
                {
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100%" Width="100%" />
                }
                else
                {
                    <textValue>
                        @RequestResult.Response
                    </textValue>
                }
            </responseBox>
        </dataSubSection>

    </basicSection>
    <activityMapSecion>
        <sectionLabel>
            ActivityMap
        </sectionLabel>
        @*<DurationMapView Scale="20" DurationMap="RequestResult.DurationMap" />*@
@*        @foreach (var activity in DiagnosticsContext.Activities)
        {
            @activity.DisplayName
            @(activity.EndTime != default)
        }*@
        <HorizontalDurationMapView Activities="DiagnosticsContext.Activities.ToList()"/>
    </activityMapSecion>
    <logsSection>
        <sectionLabel class="sectionLabel--logs">
            Logs
        </sectionLabel>
        <LogWindowView DiagnosticsContext="DiagnosticsContext" />
    </logsSection>
</resultHistoryItemExpandedView>


@code {

    [Parameter]
    [EditorRequired]
    public RequestResultContext RequestResult { get; init; }

    [Parameter]
    [EditorRequired]
    public RequestDiagnosticsContext DiagnosticsContext { get; init; }

    protected override void OnInitialized()
    {
        DiagnosticsContext.ActivityStartReceived += (s, e) =>
        {
            StateHasChanged();
        };

        DiagnosticsContext.ActivityEndReceived += (s, e) =>
        {
            StateHasChanged();
        };
        base.OnInitialized();
    }
}
