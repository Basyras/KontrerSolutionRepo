@using Basyc.Diagnostics.Shared.Durations
@using Basyc.Diagnostics.Shared.Logging
@using Basyc.MessageBus.Manager.Application
@using Basyc.MessageBus.Manager.Application.ResultDiagnostics

<horizontalDurationMapView>
    @{
        foreach (var service in RequestContext.Diagnostics.Services)
        {
            string serviceStyle = "";
            var serviceFirstActivity = service.Activities.FirstOrDefault();
            if (serviceFirstActivity is not null)
            {
                serviceStyle = $"margin-left: {DurationViewHelper.GetDurationAsRem(RequestContext.StartTime, serviceFirstActivity.StartTime, Scale)};";
            }
            <service style="@serviceStyle">
                <serviceName>
                    @service.ServiceIdentity.ServiceName
                </serviceName>
                <durationBoxes>
                    @{
                        ActivityContext previousActivity = null;
                        foreach (var activity in service.Activities)
                        {
                            var isGapBetweenPreviousNested = previousActivity is not null && previousActivity.EndTime != activity.StartTime;
                            if (isGapBetweenPreviousNested)
                            {
                                <HorizontalUnknownDurationBoxView StartTime="previousActivity.EndTime" EndTime="activity.StartTime" Scale="Scale" />
                            }

                            <HorizontalDurationBoxView Activity="activity" Scale="Scale" />
                            previousActivity = activity;
                        }
                    }

                </durationBoxes>
            </service>
        }
    }
    <MudStack Row="true">
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" OnClick="OnZoomInClick" />
        <MudText>
            @Scale
        </MudText>
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Remove" OnClick="OnZoomOutClick" />
    </MudStack>

</horizontalDurationMapView>



@code {
    [Parameter] public RequestContext RequestContext { get; set; }
    [Parameter] public double Scale { get; set; } = 1;

    protected override void OnParametersSet()
    {
        RequestContext.Diagnostics.ActivityStartReceived -= OnActivityStartReceived;
        RequestContext.Diagnostics.ActivityStartReceived += OnActivityStartReceived;
        RequestContext.Diagnostics.ActivityEndReceived -= OnActivityEneReceived;
        RequestContext.Diagnostics.ActivityEndReceived += OnActivityEneReceived;
        base.OnParametersSet();
    }

    private void OnActivityStartReceived(object sender, ActivityStart activityStart)
    {
        StateHasChanged();
    }

    private void OnActivityEneReceived(object sender, ActivityEnd activityEnd)
    {
        StateHasChanged();
    }

    private void OnZoomInClick(MouseEventArgs args)
    {
        Scale += 1;
    }

    private void OnZoomOutClick(MouseEventArgs args)
    {
        Scale -= 1;
        if (Scale <= 0)
            Scale = 1;
    }
}
